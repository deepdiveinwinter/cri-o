# CRI-O

CRI-O is light-weight Container Runtime Interface for Kubernetes.

**rootless**, **daemon-less** container that improve Docker Cons

### CRI-O Container without Docker

* [CLI] crictl/podman (replace Docker CLI)
* [CRI] CRI-O (replace docker-shim)
* [Build] buildah (replace docker build, docker buildkit)
* [Registry] skopeo (replace docker registry)

### Docker vs CRI-O (Process level)
Inspect container process on linux using `pstree` command

**Environment**

* os: CentOS 7
* image: nginx:stable-alpine

**Docker**

Create container process as child of dockerd process
```sh
docker pull nginx:stable-alpine
docker run -d -p 8881:80 --name docker-nginx nginx:stable-alpine
```

Run `pstree` command
```sh
pstree -lSps $(pidof containerd)
```

pstree result:
```sh
systemd(1)───containerd(1517)─┬─containerd-shim(4749)─┬─nginx(4766,ipc,mnt,net,pid,uts)─┬─nginx(4818)
                              │                       │                                 ├─nginx(4819)
                              │                       │                                 ├─nginx(4820)
                              │                       │                                 └─nginx(4821)
                              │                       ├─{containerd-shim}(4750)
                              │                       ├─{containerd-shim}(4751)
                              │                       ├─{containerd-shim}(4752)
                              │                       ├─{containerd-shim}(4753)
                              │                       ├─{containerd-shim}(4754)
                              │                       ├─{containerd-shim}(4755)
                              │                       ├─{containerd-shim}(4756)
                              │                       ├─{containerd-shim}(4757)
                              │                       └─{containerd-shim}(4788)
                              ├─{containerd}(1649)
                              ├─{containerd}(1650)
                              ├─{containerd}(1653)
                              ├─{containerd}(1654)
                              ├─{containerd}(1655)
                              ├─{containerd}(1749)
                              ├─{containerd}(1750)
                              ├─{containerd}(1769)
                              ├─{containerd}(1792)
                              ├─{containerd}(1809)
                              ├─{containerd}(2065)
                              ├─{containerd}(4462)
                              ├─{containerd}(4679)
                              └─{containerd}(10768)
```

**CRI-O (with podman CLI)**

Create container process with cri-o (internally using conmon utiliy)
```sh
podman pull nginx:stable-alpine
podman run -d -p 8882:80 --name crio-nginx nginx:stable-alpine
```

Run `pstree` command
```sh
podman ps --no-trunc | grep crio-nginx | awk '{print $1}'
ps -ef | grep <CONTAINER_ID>
pstree -lSps <PID>
```

pstree result:
```sh
systemd(1)───conmon(6040)─┬─nginx(6054,ipc,mnt,net,pid,uts)─┬─nginx(6092)
                          │                                 ├─nginx(6093)
                          │                                 ├─nginx(6094)
                          │                                 └─nginx(6095)
                          └─{conmon}(6042)

```

### brief comparison of container process (dockerd, cri-o)
```sh
        ├─conmon─┬─nginx───4*[nginx]
        │        └─{conmon}
        ├─containerd─┬─containerd-shim─┬─nginx───4*[nginx]
        │            │                 └─9*[{containerd-shim}]
        │            └─14*[{containerd}]

```

### podman CLI

#### Indivisual container process as systemd service

CRI-O supports container as systemd service (each container runs individually by conmon util)

```sh
podman generate systemd crio-nginx > crio-nginx.service
```

podman-nginx.service: 
```sh
# container-e757dd48eba0f251c8dfd310e3e8febefa0f941fdf2075f312e24efe50933a56.service
# autogenerated by Podman 2.0.4
# Wed Aug 19 18:54:55 KST 2020

[Unit]
Description=Podman container-e757dd48eba0f251c8dfd310e3e8febefa0f941fdf2075f312e24efe50933a56.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
ExecStart=/usr/bin/podman start e757dd48eba0f251c8dfd310e3e8febefa0f941fdf2075f312e24efe50933a56
ExecStop=/usr/bin/podman stop -t 10 e757dd48eba0f251c8dfd310e3e8febefa0f941fdf2075f312e24efe50933a56
ExecStopPost=/usr/bin/podman stop -t 10 e757dd48eba0f251c8dfd310e3e8febefa0f941fdf2075f312e24efe50933a56
PIDFile=/var/run/containers/storage/overlay-containers/e757dd48eba0f251c8dfd310e3e8febefa0f941fdf2075f312e24efe50933a56/userdata/conmon.pid
KillMode=none
Type=forking

[Install]
WantedBy=multi-user.target default.target
```

#### Generate Pod yaml for k8s

```sh
podman generate kube crio-nginx > crio-nginx.yaml
```

crio-nginx.yaml
```sh
# Generation of Kubernetes YAML is still under development!
#
# Save the output of this file and use kubectl create -f to import
# it into Kubernetes.
#
# Created with podman-2.0.4
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: "2020-08-19T09:56:55Z"
  labels:
    app: crio-nginx
  name: crio-nginx
spec:
  containers:
  - command:
    - nginx
    - -g
    - daemon off;
    env:
    - name: PATH
      value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    - name: TERM
      value: xterm
    - name: container
      value: podman
    - name: NGINX_VERSION
      value: 1.18.0
    - name: NJS_VERSION
      value: 0.4.2
    - name: PKG_RELEASE
      value: "1"
    - name: HOSTNAME
    image: docker.io/library/nginx:stable-alpine
    name: crio-nginx
    ports:
    - containerPort: 80
      hostPort: 8882
      protocol: TCP
    resources: {}
    securityContext:
      allowPrivilegeEscalation: true
      capabilities: {}
      privileged: false
      readOnlyRootFilesystem: false
      seLinuxOptions: {}
    workingDir: /
status: {}
---
metadata:
  creationTimestamp: null
spec: {}
status:
  loadBalancer: {}
```

